<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-65632006-3","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<script src="https://buttons.github.io/buttons.js"></script>
<script src="https://media.ethicalads.io/media/client/ethicalads.min.js"></script><title data-react-helmet="true">Immer performance | Immer</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Immer performance | Immer"><meta data-react-helmet="true" name="description" content="&lt;div"><meta data-react-helmet="true" property="og:description" content="&lt;div"><meta data-react-helmet="true" property="og:url" content="https://immerjs.github.io//immer/performance"><link data-react-helmet="true" rel="shortcut icon" href="/immer/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://immerjs.github.io//immer/performance"><link rel="stylesheet" href="/immer/styles.8d39bcb7.css">
<link rel="preload" href="/immer/styles.5695f530.js" as="script">
<link rel="preload" href="/immer/runtime~main.37234080.js" as="script">
<link rel="preload" href="/immer/main.9b3711a3.js" as="script">
<link rel="preload" href="/immer/1.d0155db0.js" as="script">
<link rel="preload" href="/immer/2.b57f8157.js" as="script">
<link rel="preload" href="/immer/30.73c69c5f.js" as="script">
<link rel="preload" href="/immer/935f2afb.211114bc.js" as="script">
<link rel="preload" href="/immer/17896441.b75952fb.js" as="script">
<link rel="preload" href="/immer/62d444b9.567ddcee.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><div class="announcementBar_1JSk" style="background-color:#20232a;color:#fff" role="banner"><div class="announcementBarContent_2EqR">Support Ukraine ðŸ‡ºðŸ‡¦ <a target="_blank" rel="noopener noreferrer" href="https://opensource.fb.com/support-ukraine">Help Provide Humanitarian Aid to Ukraine</a>.</div></div><nav class="navbar navbar--fixed-top navbar--dark"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/immer/"><img src="/immer/img/immer-logo.svg" alt="Immer Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/immer/img/immer-logo.svg" alt="Immer Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Immer</strong></a><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link">en</a><ul class="dropdown__menu"><li><a href="/immer/performance" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">en</a></li><li><a href="/immer/zh-CN/performance" target="_self" rel="noopener noreferrer" class="dropdown__link">zh-CN</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link navbar__link--active" href="/immer/">Documentation</a><a href="https://github.com/immerjs/immer" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><a class="navbar__item navbar__link navbar__link--active" href="/immer/support">Support Immer</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/immer/"><img src="/immer/img/immer-logo.svg" alt="Immer Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/immer/img/immer-logo.svg" alt="Immer Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Immer</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link navbar__link--active" href="/immer/">Documentation</a></li><li class="menu__list-item"><a href="https://github.com/immerjs/immer" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li><li class="menu__list-item"><a class="menu__link navbar__link--active" href="/immer/support">Support Immer</a></li><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist">Languages</a><ul class="menu__list"><li class="menu__list-item"><a href="/immer/performance" target="_self" rel="noopener noreferrer" class="menu__link dropdown__link--active">en</a></li><li class="menu__list-item"><a href="/immer/zh-CN/performance" target="_self" rel="noopener noreferrer" class="menu__link">zh-CN</a></li></ul></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><div class="docSidebarContainer_3Ak5" role="complementary"><div class="sidebar_3gvy"><div class="menu menu--responsive thin-scrollbar menu_1yIk"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_1CUI" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Basics</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/installation">Installation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/produce">Using produce</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/curried-produce">Curried producers</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/example-setstate">React &amp; Immer</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/update-patterns">Update patterns</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Advanced Features</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/api">API overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/map-set">Map and Set</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/complex-objects">Classes</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/current">Current</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/original">Original</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/patches">Patches</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/freezing">Auto freezing</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/return">Returning new data from producers</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/async">Async produce / createDraft</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/typescript">TypeScript / Flow</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Resources</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/immer/performance">Immer performance</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/immer/resources">External resources</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/immer/faq">FAQ</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/immer/pitfalls">Pitfalls</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/immer/built-with">Built with Immer</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/immer/support">Supporting immer</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/immer/other-lang">Porting to other languages</a></li></ul></li></ul></div></div></div><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="docItemContainer_a7m4"><article><header><h1 class="docTitle_Oumm">Immer performance</h1></header><div class="markdown"><center><div data-ea-publisher="immerjs" data-ea-type="image" class="horizontal bordered"></div></center> <details><summary class="egghead-summary">egghead.io lesson 5: Leveraging Immer&#x27;s structural sharing in React</summary><br><div><iframe width="760" height="427" scrolling="no" src="https://egghead.io/lessons/react-profile-react-rendering-and-optimize-with-memo-to-leverage-structural-sharing/embed"></iframe></div><a href="https://egghead.io/lessons/react-profile-react-rendering-and-optimize-with-memo-to-leverage-structural-sharing" target="_blank" rel="noopener noreferrer" class="egghead-link">Hosted on egghead.io</a></details> <details><summary class="egghead-summary">egghead.io lesson 7: Immer will try to re-cycle data if there was no semantic change</summary><br><div><iframe width="760" height="427" scrolling="no" src="https://egghead.io/lessons/javascript-produces-immutable-data-and-avoid-unnecessary-creation-of-new-data-trees-with-immer/embed"></iframe></div><a href="https://egghead.io/lessons/javascript-produces-immutable-data-and-avoid-unnecessary-creation-of-new-data-trees-with-immer" target="_blank" rel="noopener noreferrer" class="egghead-link">Hosted on egghead.io</a></details><p>Here is a <a href="https://github.com/immerjs/immer/blob/master/__performance_tests__/todo.js" target="_blank" rel="noopener noreferrer">simple benchmark</a> on the performance of Immer. This test takes 50,000 todo items and updates 5,000 of them. <em>Freeze</em> indicates that the state tree has been frozen after producing it. This is a <em>development</em> best practice, as it prevents developers from accidentally modifying the state tree.</p><p>Something that isn&#x27;t reflected in the numbers above, but in reality, Immer is sometimes significantly <em>faster</em> than a hand written reducer. The reason for that is that Immer will detect &quot;no-op&quot; state changes, and return the original state if nothing actually changed, which can avoid a lot of re-renderings for example. Cases are known where simply applying immer solved critical performance issues.</p><p>These tests were executed on Node 10.16.3. Use <code>yarn test:perf</code> to reproduce them locally.</p><p><img alt="performance.png" src="/immer/assets/images/performance-c7f59d06ec36f4a05b6403daada96542.png"></p><p>Most important observation:</p><ul><li>Immer with proxies is roughly speaking twice to three times slower as a handwritten reducer (the above test case is worst case, see <code>yarn test:perf</code> for more tests). This is in practice negligible.</li><li>Immer is roughly as fast as ImmutableJS. However, the <em>immutableJS + toJS</em> makes clear the cost that often needs to be paid later; converting the immutableJS objects back to plain objects, to be able to pass them to components, over the network etc... (And there is also the upfront cost of converting data received from e.g. the server to immutable JS)</li><li>Generating patches doesn&#x27;t significantly slow down immer</li><li>The ES5 fallback implementation is roughly twice as slow as the proxy implementation, in some cases worse.</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="performance-tips"></a>Performance tips<a class="hash-link" href="#performance-tips" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="pre-freeze-data"></a>Pre-freeze data<a class="hash-link" href="#pre-freeze-data" title="Direct link to heading">#</a></h3><p>When adding a large data set to the state tree in an Immer producer (for example data received from a JSON endpoint), it is worth to call <code>freeze(json)</code> on the root of the data that is being added first. To <em>shallowly</em> freeze it. This will allow Immer to add the new data to the tree faster, as it will avoid the need to <em>recursively</em> scan and freeze the new data.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="you-can-always-opt-out"></a>You can always opt-out<a class="hash-link" href="#you-can-always-opt-out" title="Direct link to heading">#</a></h3><p>Realize that immer is opt-in everywhere, so it is perfectly fine to manually write super performance critical reducers, and use immer for all the normal ones. Even from within a producer you opt-out from Immer for certain parts of your logic by using utilies <code>original</code> or <code>current</code> and perform some of your operations on plain JavaScript objects.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="for-expensive-search-operations-read-from-the-original-state-not-the-draft"></a>For expensive search operations, read from the original state, not the draft<a class="hash-link" href="#for-expensive-search-operations-read-from-the-original-state-not-the-draft" title="Direct link to heading">#</a></h3><p>Immer will convert anything you read in a draft recursively into a draft as well. If you have expensive side effect free operations on a draft that involves a lot of reading, for example finding an index using <code>find(Index)</code> in a very large array, you can speed this up by first doing the search, and only call the <code>produce</code> function once you know the index. Thereby preventing Immer to turn everything that was searched for in a draft. Or, alternatively, perform the search on the original value of a draft, by using <code>original(someDraft)</code>, which boils to the same thing.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="pull-produce-as-far-up-as-possible"></a>Pull produce as far up as possible<a class="hash-link" href="#pull-produce-as-far-up-as-possible" title="Direct link to heading">#</a></h3><p>Always try to pull produce &#x27;up&#x27;, for example <code>for (let x of y) produce(base, d =&gt; d.push(x))</code> is exponentially slower than <code>produce(base, d =&gt; { for (let x of y) d.push(x)})</code></p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/immerjs/immer/edit/master/website/docs/performance.mdx" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/immer/typescript"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Using TypeScript or Flow</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/immer/resources"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">External resources Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#performance-tips" class="table-of-contents__link">Performance tips</a><ul><li><a href="#pre-freeze-data" class="table-of-contents__link">Pre-freeze data</a></li><li><a href="#you-can-always-opt-out" class="table-of-contents__link">You can always opt-out</a></li><li><a href="#for-expensive-search-operations-read-from-the-original-state-not-the-draft" class="table-of-contents__link">For expensive search operations, read from the original state, not the draft</a></li><li><a href="#pull-produce-as-far-up-as-possible" class="table-of-contents__link">Pull produce as far up as possible</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 Michel Weststrate</div></div></div></footer></div>
<script src="/immer/styles.5695f530.js"></script>
<script src="/immer/runtime~main.37234080.js"></script>
<script src="/immer/main.9b3711a3.js"></script>
<script src="/immer/1.d0155db0.js"></script>
<script src="/immer/2.b57f8157.js"></script>
<script src="/immer/30.73c69c5f.js"></script>
<script src="/immer/935f2afb.211114bc.js"></script>
<script src="/immer/17896441.b75952fb.js"></script>
<script src="/immer/62d444b9.567ddcee.js"></script>
</body>
</html>