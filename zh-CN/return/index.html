<!doctype html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-65632006-3","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<script src="https://buttons.github.io/buttons.js"></script>
<script src="https://media.ethicalads.io/media/client/ethicalads.min.js"></script><title data-react-helmet="true">从 producers 返回新数据 | Immer</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="zh-CN"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="从 producers 返回新数据 | Immer"><meta data-react-helmet="true" name="description" content="&lt;div"><meta data-react-helmet="true" property="og:description" content="&lt;div"><meta data-react-helmet="true" property="og:url" content="https://immerjs.github.io//immer/zh-CN/return"><link data-react-helmet="true" rel="shortcut icon" href="/immer/zh-CN/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://immerjs.github.io//immer/zh-CN/return"><link rel="stylesheet" href="/immer/zh-CN/styles.8d39bcb7.css">
<link rel="preload" href="/immer/zh-CN/styles.70ca39db.js" as="script">
<link rel="preload" href="/immer/zh-CN/runtime~main.1fe0de69.js" as="script">
<link rel="preload" href="/immer/zh-CN/main.b4ec7216.js" as="script">
<link rel="preload" href="/immer/zh-CN/1.d0155db0.js" as="script">
<link rel="preload" href="/immer/zh-CN/2.b57f8157.js" as="script">
<link rel="preload" href="/immer/zh-CN/30.a3278a17.js" as="script">
<link rel="preload" href="/immer/zh-CN/935f2afb.93358b33.js" as="script">
<link rel="preload" href="/immer/zh-CN/17896441.04470a9c.js" as="script">
<link rel="preload" href="/immer/zh-CN/97ddec0c.e3ba82e6.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><div class="announcementBar_1JSk" style="background-color:#20232a;color:#fff" role="banner"><div class="announcementBarContent_2EqR">Support Ukraine 🇺🇦 <a target="_blank" rel="noopener noreferrer" href="https://opensource.fb.com/support-ukraine">Help Provide Humanitarian Aid to Ukraine</a>.</div></div><nav class="navbar navbar--fixed-top navbar--dark"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/immer/zh-CN/"><img src="/immer/zh-CN/img/immer-logo.svg" alt="Immer Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/immer/zh-CN/img/immer-logo.svg" alt="Immer Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Immer</strong></a><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link">zh-CN</a><ul class="dropdown__menu"><li><a href="/immer/return" target="_self" rel="noopener noreferrer" class="dropdown__link">en</a></li><li><a href="/immer/zh-CN/return" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">zh-CN</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link navbar__link--active" href="/immer/zh-CN/">文档</a><a href="https://github.com/immerjs/immer" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><a class="navbar__item navbar__link navbar__link--active" href="/immer/zh-CN/support">赞助 Immer</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/immer/zh-CN/"><img src="/immer/zh-CN/img/immer-logo.svg" alt="Immer Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/immer/zh-CN/img/immer-logo.svg" alt="Immer Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Immer</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link navbar__link--active" href="/immer/zh-CN/">文档</a></li><li class="menu__list-item"><a href="https://github.com/immerjs/immer" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li><li class="menu__list-item"><a class="menu__link navbar__link--active" href="/immer/zh-CN/support">赞助 Immer</a></li><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist">Languages</a><ul class="menu__list"><li class="menu__list-item"><a href="/immer/return" target="_self" rel="noopener noreferrer" class="menu__link">en</a></li><li class="menu__list-item"><a href="/immer/zh-CN/return" target="_self" rel="noopener noreferrer" class="menu__link dropdown__link--active">zh-CN</a></li></ul></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><div class="docSidebarContainer_3Ak5" role="complementary"><div class="sidebar_3gvy"><div class="menu menu--responsive thin-scrollbar menu_1yIk"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_1CUI" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">基础</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/zh-CN/">入门</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/zh-CN/installation">安装</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/zh-CN/produce">使用 produce</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/zh-CN/curried-produce">柯里化 producers</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/zh-CN/example-setstate">React &amp; Immer</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/zh-CN/update-patterns">更新模式</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">高级</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/immer/zh-CN/api">API 概览</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/immer/zh-CN/map-set">Map 和 Set</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/immer/zh-CN/complex-objects">类</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/immer/zh-CN/current">Current</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/immer/zh-CN/original">Original</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/immer/zh-CN/patches">Patches</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/immer/zh-CN/freezing">自动冻结</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/immer/zh-CN/return">从 producers 返回新数据</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/immer/zh-CN/async">异步 produce / createDraft</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/immer/zh-CN/typescript">TypeScript / Flow</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">资源</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/zh-CN/performance">Immer 性能</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/zh-CN/resources">外部资源</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/zh-CN/faq">FAQ</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/zh-CN/pitfalls">陷阱</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/zh-CN/built-with">基于 Immer</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/zh-CN/support">赞助 immer</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/zh-CN/other-lang">Porting to other languages</a></li></ul></li></ul></div></div></div><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="docItemContainer_a7m4"><article><header><h1 class="docTitle_Oumm">从 producers 返回新数据</h1></header><div class="markdown"><center><div data-ea-publisher="immerjs" data-ea-type="image" class="horizontal bordered"></div></center><details><summary class="egghead-summary">egghead.io 第9课: 返回全新 state</summary><br><div><iframe width="760" height="427" scrolling="no" src="https://egghead.io/lessons/react-return-completely-new-state-from-an-immer-producer/embed"></iframe></div><a href="https://egghead.io/lessons/react-return-completely-new-state-from-an-immer-producer" target="_blank" rel="noopener noreferrer" class="egghead-link">Hosted on egghead.io</a></details><p>不需要从 producer 那里返回任何东西，因为 Immer 无论如何都会返回 <code>draft</code> 的（最终）版本。但是，也允许仅仅 <code>return draft</code>。</p><p>也允许从 producer 函数中任意返回其他数据。但<em>前提</em>是你没有修改 <code>draft</code>。这对于产生一个全新的 state 很有用。一些例子：</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-javascript codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> userReducer </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">produce</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token parameter">draft</span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token parameter"> action</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">action</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">type</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">case</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;renameUser&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">//可以： 我们修改了当前的 state</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            draft</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">users</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">action</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">payload</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">name</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> action</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">payload</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">name</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> draft </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// 与仅仅 &#x27;return&#x27; 相同</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">case</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;loadUsers&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// 可以: 我们返回了一个全新的 state</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> action</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">payload</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">case</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;adduser-1&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// 不行: 这不会改变 draft ，也不会返回新的状态</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// 它不会修改 draft（它只是重新声明它）</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// 事实上，这根本没有做任何事情</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            draft </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">users</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token spread operator" style="color:rgb(137, 221, 255)">...</span><span class="token plain">draft</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">users</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> action</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">payload</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">case</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;adduser-2&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// 不行: 修改 draft 的同时返回了一个新的状态</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            draft</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">userCount</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">+=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">users</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token spread operator" style="color:rgb(137, 221, 255)">...</span><span class="token plain">draft</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">users</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> action</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">payload</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">case</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;adduser-3&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// 可以: 返回一个新的状态。但是，不必要的复杂和昂贵</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                userCount</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> draft</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">userCount</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                users</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token spread operator" style="color:rgb(137, 221, 255)">...</span><span class="token plain">draft</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">users</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> action</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">payload</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">case</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;adduser-4&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// 可以: immer 的方式</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            draft</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">userCount</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">+=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            draft</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">users</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">push</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">action</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">payload</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><em>注意：无法以这种方式返回 <code>undefined</code> ，因为它与不更新 draft 没有区别！继续阅读......</em></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="使用-nothing-产生-undefined"></a>使用 <code>nothing</code> 产生 <code>undefined</code><a class="hash-link" href="#使用-nothing-产生-undefined" title="Direct link to heading">#</a></h2><p>因此，一般来说，可以通过从 producer 返回一个新值来替换当前 state，而不是修改 draft。然而，有一个微妙的边缘情况：如果您尝试编写一个想要用 undefined 替换当前状态的 producer：</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-javascript codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">produce</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token parameter">draft</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// 什么也不干</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>或者:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-javascript codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">produce</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token parameter">draft</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// 尝试从 producer 中返回 undefined</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token keyword nil" style="font-style:italic">undefined</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>问题在于，在 JavaScript 中，一个不返回任何内容的函数也会返回 <code>undefined</code>！所以 immer 无法区分这些不同的情况。因此，默认情况下，Immer 会假设任何返回 <code>undefined</code> 的 producer 只是试图修改 draft。</p><p>但是，为了让 Immer 清楚您有意生成 <code>undefined</code> 值，您可以返回内置标记 <code>nothing</code>：</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-javascript codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword module" style="font-style:italic">import</span><span class="token plain"> produce</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">nothing</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword module" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;immer&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> state </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    hello</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;world&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">produce</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">state</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token parameter">draft</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">produce</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">state</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token parameter">draft</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token keyword nil" style="font-style:italic">undefined</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// 都会返回最初的状态: { hello: &quot;world&quot;} </span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">produce</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">state</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token parameter">draft</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> nothing</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// 产生一个新的状态, &#x27;undefined&#x27;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>注：请注意，此问题特定于 <code>undefined</code> 值，任何其他值（包括 <code>null</code>）都不会受到此问题的影响</p><p>提示：为了能够在使用 TypeScript 时从 recipe 中返回 <code>nothing</code>，<code>state</code> 的类型必须接受 undefined 值。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="使用-void-的内联快捷方式"></a>使用 <code>void</code> 的内联快捷方式<a class="hash-link" href="#使用-void-的内联快捷方式" title="Direct link to heading">#</a></h2><details><summary class="egghead-summary">egghead.io 第10课: 使用 _void_ 避免意外的返回</summary><br><div><iframe width="760" height="427" scrolling="no" src="https://egghead.io/lessons/react-avoid-accidental-returns-of-new-state-by-using-the-void-keyword/embed"></iframe></div><a href="https://egghead.io/lessons/react-avoid-accidental-returns-of-new-state-by-using-the-void-keyword" target="_blank" rel="noopener noreferrer" class="egghead-link">Hosted on egghead.io</a></details><p>Immer 中的 draft 修改通常需要一段代码块，因为返回表示覆盖。有时候你可能觉得这么多的样板代码很糟心。</p><p>在这种情况下，您可以使用 javascripts <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/void" target="_blank" rel="noopener noreferrer"><code>void</code></a> 运算符，它计算表达式并返回 <code>undefined</code>。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-javascript codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// 单次修改</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">produce</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token parameter">draft</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">draft</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">user</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">age</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">+=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// 多次修改</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">produce</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token parameter">draft</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">draft</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">user</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">age</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">+=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">draft</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">user</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">height</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">186</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>代码风格是高度个人化的，但对于要被许多人理解的代码库，我们建议坚持经典的  <code>draft =&gt; { draft.user.age += 1}</code> 以避免认知开销。</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/immerjs/immer/edit/master/website/i18n/zh-CN/docusaurus-plugin-content-docs/current/return.mdx" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/immer/zh-CN/freezing"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« 自动冻结</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/immer/zh-CN/async"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">异步 producers &amp; createDraft / finishDraft »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#使用-nothing-产生-undefined" class="table-of-contents__link">使用 <code>nothing</code> 产生 <code>undefined</code></a></li><li><a href="#使用-void-的内联快捷方式" class="table-of-contents__link">使用 <code>void</code> 的内联快捷方式</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Michel Weststrate</div></div></div></footer></div>
<script src="/immer/zh-CN/styles.70ca39db.js"></script>
<script src="/immer/zh-CN/runtime~main.1fe0de69.js"></script>
<script src="/immer/zh-CN/main.b4ec7216.js"></script>
<script src="/immer/zh-CN/1.d0155db0.js"></script>
<script src="/immer/zh-CN/2.b57f8157.js"></script>
<script src="/immer/zh-CN/30.a3278a17.js"></script>
<script src="/immer/zh-CN/935f2afb.93358b33.js"></script>
<script src="/immer/zh-CN/17896441.04470a9c.js"></script>
<script src="/immer/zh-CN/97ddec0c.e3ba82e6.js"></script>
</body>
</html>