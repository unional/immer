<!doctype html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-65632006-3","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<script src="https://buttons.github.io/buttons.js"></script>
<script src="https://media.ethicalads.io/media/client/ethicalads.min.js"></script><title data-react-helmet="true">Immer 性能 | Immer</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="zh-CN"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Immer 性能 | Immer"><meta data-react-helmet="true" name="description" content="&lt;div"><meta data-react-helmet="true" property="og:description" content="&lt;div"><meta data-react-helmet="true" property="og:url" content="https://immerjs.github.io//immer/zh-CN/performance"><link data-react-helmet="true" rel="shortcut icon" href="/immer/zh-CN/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://immerjs.github.io//immer/zh-CN/performance"><link rel="stylesheet" href="/immer/zh-CN/styles.8d39bcb7.css">
<link rel="preload" href="/immer/zh-CN/styles.70ca39db.js" as="script">
<link rel="preload" href="/immer/zh-CN/runtime~main.1fe0de69.js" as="script">
<link rel="preload" href="/immer/zh-CN/main.b4ec7216.js" as="script">
<link rel="preload" href="/immer/zh-CN/1.d0155db0.js" as="script">
<link rel="preload" href="/immer/zh-CN/2.b57f8157.js" as="script">
<link rel="preload" href="/immer/zh-CN/30.a3278a17.js" as="script">
<link rel="preload" href="/immer/zh-CN/935f2afb.93358b33.js" as="script">
<link rel="preload" href="/immer/zh-CN/17896441.04470a9c.js" as="script">
<link rel="preload" href="/immer/zh-CN/a11e3352.2351b934.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><div class="announcementBar_1JSk" style="background-color:#20232a;color:#fff" role="banner"><div class="announcementBarContent_2EqR">Support Ukraine 🇺🇦 <a target="_blank" rel="noopener noreferrer" href="https://opensource.fb.com/support-ukraine">Help Provide Humanitarian Aid to Ukraine</a>.</div></div><nav class="navbar navbar--fixed-top navbar--dark"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/immer/zh-CN/"><img src="/immer/zh-CN/img/immer-logo.svg" alt="Immer Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/immer/zh-CN/img/immer-logo.svg" alt="Immer Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Immer</strong></a><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link">zh-CN</a><ul class="dropdown__menu"><li><a href="/immer/performance" target="_self" rel="noopener noreferrer" class="dropdown__link">en</a></li><li><a href="/immer/zh-CN/performance" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">zh-CN</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link navbar__link--active" href="/immer/zh-CN/">文档</a><a href="https://github.com/immerjs/immer" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><a class="navbar__item navbar__link navbar__link--active" href="/immer/zh-CN/support">赞助 Immer</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/immer/zh-CN/"><img src="/immer/zh-CN/img/immer-logo.svg" alt="Immer Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/immer/zh-CN/img/immer-logo.svg" alt="Immer Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Immer</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link navbar__link--active" href="/immer/zh-CN/">文档</a></li><li class="menu__list-item"><a href="https://github.com/immerjs/immer" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li><li class="menu__list-item"><a class="menu__link navbar__link--active" href="/immer/zh-CN/support">赞助 Immer</a></li><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist">Languages</a><ul class="menu__list"><li class="menu__list-item"><a href="/immer/performance" target="_self" rel="noopener noreferrer" class="menu__link">en</a></li><li class="menu__list-item"><a href="/immer/zh-CN/performance" target="_self" rel="noopener noreferrer" class="menu__link dropdown__link--active">zh-CN</a></li></ul></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><div class="docSidebarContainer_3Ak5" role="complementary"><div class="sidebar_3gvy"><div class="menu menu--responsive thin-scrollbar menu_1yIk"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_1CUI" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">基础</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/zh-CN/">入门</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/zh-CN/installation">安装</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/zh-CN/produce">使用 produce</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/zh-CN/curried-produce">柯里化 producers</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/zh-CN/example-setstate">React &amp; Immer</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/zh-CN/update-patterns">更新模式</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">高级</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/zh-CN/api">API 概览</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/zh-CN/map-set">Map 和 Set</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/zh-CN/complex-objects">类</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/zh-CN/current">Current</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/zh-CN/original">Original</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/zh-CN/patches">Patches</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/zh-CN/freezing">自动冻结</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/zh-CN/return">从 producers 返回新数据</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/zh-CN/async">异步 produce / createDraft</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/immer/zh-CN/typescript">TypeScript / Flow</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">资源</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/immer/zh-CN/performance">Immer 性能</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/immer/zh-CN/resources">外部资源</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/immer/zh-CN/faq">FAQ</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/immer/zh-CN/pitfalls">陷阱</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/immer/zh-CN/built-with">基于 Immer</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/immer/zh-CN/support">赞助 immer</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/immer/zh-CN/other-lang">Porting to other languages</a></li></ul></li></ul></div></div></div><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="docItemContainer_a7m4"><article><header><h1 class="docTitle_Oumm">Immer 性能</h1></header><div class="markdown"><center><div data-ea-publisher="immerjs" data-ea-type="image" class="horizontal bordered"></div></center> <details><summary class="egghead-summary">egghead.io 第5课: 在 React 中利用 Immer 的结构共享</summary><br><div><iframe width="760" height="427" scrolling="no" src="https://egghead.io/lessons/react-profile-react-rendering-and-optimize-with-memo-to-leverage-structural-sharing/embed"></iframe></div><a href="https://egghead.io/lessons/react-profile-react-rendering-and-optimize-with-memo-to-leverage-structural-sharing" target="_blank" rel="noopener noreferrer" class="egghead-link">Hosted on egghead.io</a></details> <details><summary class="egghead-summary">egghead.io 第7课: 如果没有语义变化，Immer 会使用原先的数据</summary><br><div><iframe width="760" height="427" scrolling="no" src="https://egghead.io/lessons/javascript-produces-immutable-data-and-avoid-unnecessary-creation-of-new-data-trees-with-immer/embed"></iframe></div><a href="https://egghead.io/lessons/javascript-produces-immutable-data-and-avoid-unnecessary-creation-of-new-data-trees-with-immer" target="_blank" rel="noopener noreferrer" class="egghead-link">Hosted on egghead.io</a></details><p>这是一个关于 Immer 性能的 <a href="https://github.com/immerjs/immer/blob/master/__performance_tests__/todo.js" target="_blank" rel="noopener noreferrer">简单 benchmark</a> 。该测试需要 50,000 个待办事项并更新其中的 5,000 个。 <em>Freeze</em> 表示状态树在生成后已被冻结。这是一种开发最佳实践，因为它可以防止开发人员意外修改状态树。</p><p>上面的数字没有反映一些东西，但实际上，Immer 有时比手写的 reducer <em>快</em> 得多。这样做的原因是，Immer 会检测“无操作”状态变化，如果实际上没有任何变化，则返回原始状态，这可以避免很多重新渲染。众所周知，只需应用 immer 即可解决关键性能问题。</p><p>这些测试在 Node 10.16.3 上执行。使用 <code>yarn test:perf</code> 在本地重现它们。</p><p><img alt="performance.png" src="/immer/zh-CN/assets/images/performance-c7f59d06ec36f4a05b6403daada96542.png"></p><p>最重要的结论:</p><ul><li>Immer with proxies 大约比手写 reducer 慢 2 到 3 倍（上面的测试用例是最坏的情况，请参阅 <code>yarn test:perf</code> 了解更多测试情况）。这在实践中可以忽略不计。</li><li>Immer 的速度大致与 ImmutableJS 一样快。但是，<em>immutableJS + toJS</em> 明确了后期往往需要付出的代价；将 immutableJS 对象转换回普通对象，以便将它们传递给组件或者进行序列化操作在网络中传输......（还有将从服务器接收到的数据转换为不可变 JS 的前期成本）</li><li>生成 patches 不会显著减慢 immer</li><li>ES5 后备实现的速度大约比代理实现慢两倍，在某些情况下更糟。</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="性能提示"></a>性能提示<a class="hash-link" href="#性能提示" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="预冻结数据"></a>预冻结数据<a class="hash-link" href="#预冻结数据" title="Direct link to heading">#</a></h3><p>当向 Immer producer 中的状态树添加大型数据集时（例如从 JSON 端点接收的数据），可以在首先添加的数据的根上调用 <code>freeze(json)</code> ，来<em>浅冻结</em>它。这将允许 Immer 更快地将新数据添加到树中，因为它将避免<em>递归</em>扫描和冻结新数据的需要。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="您可以随时选择退出"></a>您可以随时选择退出<a class="hash-link" href="#您可以随时选择退出" title="Direct link to heading">#</a></h3><p>immer 在任何地方都是可选的，因此手动编写性能非常苛刻的 reducers ，并将 immer 用于所有普通的的 reducers 是非常好的。即使在 producer 内部，您也可以通过使用 <code>original</code> 或 <code>current</code> 函数来选择退出 Immer 的某些部分逻辑，并对纯 JavaScript 对象执行一些操作。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="对于昂贵的搜索操作，从原始-state-读取，而不是-draft"></a>对于昂贵的搜索操作，从原始 state 读取，而不是 draft<a class="hash-link" href="#对于昂贵的搜索操作，从原始-state-读取，而不是-draft" title="Direct link to heading">#</a></h3><p>Immer 会将您在 draft 中读取的任何内容也递归地转换为 draft。如果您对涉及大量读取操作的 draft 进行昂贵的无副作用操作，例如在非常大的数组中使用 <code>find(Index)</code> 查找索引，您可以通过首先进行搜索，并且只在知道索引后调用 <code>produce</code> 来加快速度。这样可以阻止 Immer 将在 draft 中搜索到的所有内容都进行转换。或者，使用 <code>original(someDraft)</code> 对 draft 的原始值执行搜索，这归结为同样的事情。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="将-produce-拉到尽可能远的地方"></a>将 produce 拉到尽可能远的地方<a class="hash-link" href="#将-produce-拉到尽可能远的地方" title="Direct link to heading">#</a></h3><p>始终尝试将 produce “向上”拉动，例如 <code>for (let x of y) produce(base, d =&gt; d.push(x))</code> 比 <code>produce(base, d =&gt; { for (let x of y) ) d.push(x)})</code> 慢得多</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/immerjs/immer/edit/master/website/i18n/zh-CN/docusaurus-plugin-content-docs/current/performance.mdx" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/immer/zh-CN/typescript"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Using TypeScript or Flow</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/immer/zh-CN/resources"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">外部资源 »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#性能提示" class="table-of-contents__link">性能提示</a><ul><li><a href="#预冻结数据" class="table-of-contents__link">预冻结数据</a></li><li><a href="#您可以随时选择退出" class="table-of-contents__link">您可以随时选择退出</a></li><li><a href="#对于昂贵的搜索操作，从原始-state-读取，而不是-draft" class="table-of-contents__link">对于昂贵的搜索操作，从原始 state 读取，而不是 draft</a></li><li><a href="#将-produce-拉到尽可能远的地方" class="table-of-contents__link">将 produce 拉到尽可能远的地方</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Michel Weststrate</div></div></div></footer></div>
<script src="/immer/zh-CN/styles.70ca39db.js"></script>
<script src="/immer/zh-CN/runtime~main.1fe0de69.js"></script>
<script src="/immer/zh-CN/main.b4ec7216.js"></script>
<script src="/immer/zh-CN/1.d0155db0.js"></script>
<script src="/immer/zh-CN/2.b57f8157.js"></script>
<script src="/immer/zh-CN/30.a3278a17.js"></script>
<script src="/immer/zh-CN/935f2afb.93358b33.js"></script>
<script src="/immer/zh-CN/17896441.04470a9c.js"></script>
<script src="/immer/zh-CN/a11e3352.2351b934.js"></script>
</body>
</html>